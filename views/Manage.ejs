<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Members</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="icon" type="image/png" href="/photo/dumbells.png">
</head>
<body>
  <header class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/Home.html">
        <img src="/photo/dumbells.png" alt="Logo" style="height: 30px;">
        GonnaFit Admin
      </a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="/Dash.html">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link active" href="/Manage.html">Manage</a></li>
        </ul>
        <div class="d-flex" id="user-buttons">
          <% if (user && user.displayname) { %>
            <span class="navbar-text me-3 text-white">
              สวัสดี, <%= user.displayname %> <%= user.surname ?? "" %>
            </span>
            <a class="btn btn-outline-light" href="/logout">Log out</a>
          <% } else { %>
            <a class="btn btn-outline-light" href="/logout">Log out</a>
          <% } %>
        </div>
      </div>
    </div>
  </header>

  <main class="container mt-4">
    <h1 class="mb-3">Manage Members</h1>

    <div class="mb-3">
      <input type="text" id="search" class="form-control" placeholder="ค้นหาชื่อสมาชิก...">
    </div>

    <table class="table table-bordered table-striped align-middle">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>ชื่อ</th>
          <th>นามสกุล</th>
          <th>Email</th>
          <th>Role</th>
          <th>วันที่สมัคร</th>
          <th>จัดการ</th>
        </tr>
      </thead>
      <tbody id="member-table">
        <% if (members && members.length > 0) { %>
          <% members.forEach((m, i) => { %>
            <tr>
              <td><%= i + 1 %></td>
              <td><%= m.displayname %></td>
              <td><%= m.surname ?? "" %></td>
              <td><%= m.email %></td>
              <td><%= m.role %></td>
              <td><%= new Date(m.created_at).toLocaleDateString() %></td>
              <td>
                <button class="btn btn-warning btn-sm edit-btn" data-id="<%= m.id %>">แก้ไข</button>
                <button class="btn btn-danger btn-sm delete-btn" data-id="<%= m.id %>">ลบ</button>
              </td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr><td colspan="7" class="text-center">ไม่พบข้อมูล</td></tr>
        <% } %>
      </tbody>
    </table>
  </main>

  <!-- Modal แก้ไขสมาชิก -->
  <div class="modal fade" id="memberModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">แก้ไขสมาชิก</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="memberForm">
          <div class="modal-body">
            <input type="hidden" id="memberId">
            <div class="mb-3">
              <label class="form-label">ชื่อ</label>
              <input type="text" class="form-control" id="displayname" required>
            </div>
            <div class="mb-3">
              <label class="form-label">นามสกุล</label>
              <input type="text" class="form-control" id="surname">
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Role</label>
              <select class="form-select" id="role">
                <option value="Member">Member</option>
                <option value="Admin">Admin</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
            <button type="submit" class="btn btn-primary">บันทึก</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
        const tableBody = document.getElementById("member-table");
        const searchInput = document.getElementById("search");
        const memberModal = new bootstrap.Modal(document.getElementById("memberModal"));
        const memberForm = document.getElementById("memberForm");
        const modalTitle = document.getElementById("modalTitle");

        // โหลดข้อมูลสมาชิก
        async function loadMembers(keyword = "") {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">กำลังโหลด...</td></tr>';
            try {
                const res = await fetch(`/api/admin/members?search=${encodeURIComponent(keyword)}`, { credentials: "include" });
                const data = await res.json();

                if (!data.length) {
                    tableBody.innerHTML = `<tr><td colspan="7" class="text-center">ไม่พบข้อมูล</td></tr>`;
                    return;
                }

                tableBody.innerHTML = "";
                data.forEach((m, i) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${i + 1}</td>
                        <td>${m.displayname}</td>
                        <td>${m.surname ?? ""}</td>
                        <td>${m.email}</td>
                        <td>${m.role}</td>
                        <td>${new Date(m.created_at).toLocaleDateString()}</td>
                        <td>
                          <button class="btn btn-warning btn-sm edit-btn" data-id="${m.id}">แก้ไข</button>
                          <button class="btn btn-danger btn-sm delete-btn" data-id="${m.id}">ลบ</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });

                // ปุ่มแก้ไข
                document.querySelectorAll(".edit-btn").forEach(btn => {
                    btn.addEventListener("click", e => openEditModal(e.target.dataset.id));
                });

                // ปุ่มลบ
                document.querySelectorAll(".delete-btn").forEach(btn => {
                    btn.addEventListener("click", async e => {
                        const id = parseInt(e.target.dataset.id, 10);
                        if (isNaN(id)) return alert("รหัสสมาชิกไม่ถูกต้อง");

                        if (confirm("แน่ใจว่าต้องการลบสมาชิกนี้?")) {
                            const res = await fetch(`/api/admin/delete-member/${id}`, {
                                method: "DELETE",
                                credentials: "include"
                            });
                            if (res.ok) {
                                alert("ลบสำเร็จ");
                                loadMembers(searchInput.value);
                            } else alert("ลบไม่สำเร็จ");
                        }
                    });
                });

            } catch (err) {
                console.error(err);
                tableBody.innerHTML = `<tr><td colspan="7" class="text-danger text-center">โหลดข้อมูลล้มเหลว</td></tr>`;
            }
        }

      // เปิด modal แก้ไข
      async function openEditModal(id) {
          const numId = parseInt(id, 10);
          if (isNaN(numId)) return alert("รหัสสมาชิกไม่ถูกต้อง");

          const res = await fetch(`/api/admin/member/${numId}`, { credentials: "include" });
          const m = await res.json();

          modalTitle.textContent = "แก้ไขข้อมูลสมาชิก";
          document.getElementById("memberId").value = m.userid;
          document.getElementById("displayname").value = m.displayname;
          document.getElementById("surname").value = m.surname ?? "";
          document.getElementById("email").value = m.email;
          document.getElementById("role").value = m.role;
          memberModal.show();
      }


      // บันทึกข้อมูล
      memberForm.addEventListener("submit", async e => {
          e.preventDefault();

          const id = parseInt(document.getElementById("memberId").value, 10);
          if (isNaN(id)) return alert("รหัสสมาชิกไม่ถูกต้อง");

          const payload = {
              displayname: document.getElementById("displayname").value,
              surname: document.getElementById("surname").value,
              email: document.getElementById("email").value,
              role: document.getElementById("role").value
          };

          try {
              const res = await fetch(`/api/admin/update-member/${id}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                  credentials: "include"
              });
              if (res.ok) {
                  alert("บันทึกสำเร็จ");
                  memberModal.hide();
                  loadMembers();
              } else {
                  alert("บันทึกล้มเหลว");
              }
          } catch (err) {
              console.error(err);
              alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
          }
      });

      // โหลดเริ่มต้น
      loadMembers();
      searchInput.addEventListener("input", e => loadMembers(e.target.value));
  });
  </script>
</body>
</html>
